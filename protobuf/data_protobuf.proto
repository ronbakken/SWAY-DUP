/*
INF Marketplace
Copyright (C) 2018  INF Marketplace LLC
Author: Jan Boon <kaetemi@no-break.space>
*/

/*

Planned changes:
- Support both geohash and s2 in location info for evaluation
- Aggregate image urls into a generic structure (blurred data or url and full image url)
- Specialized fields for non-text chat messages (storing protobuf blob in database)
- Separate offer terms into 'terms' structure for re use in proposal transactions
- Brand accounts can be created as shared accounts without authentication mechanism (cf Facebook Pages, YouTube Channels, etc)

*/

syntax = "proto3";

package inf_common;
option csharp_namespace = "InfCommon";

import 'enum_protobuf.proto';

// This message MUST NOT contain 'repeated' due to usage of 'mergeFromMessage'
message DataSocialMedia {
  /// Social media is connected to the account
  bool connected = 1;
  /// Token for connection is expired, data outdated and user must re-connect 
  /// by OAuth (happens if the user revokes the token from the social provider)
  bool expired = 15;
  
  /// TODO: Information from this social media connection may be published to other users (user setting)
  // bool published = 17;
  /// TODO: Allow logging in with this account (user setting)
  // bool allow_log_in = 18;
  /// TODO: Possible to log in or sign up with the connected account (user setting)
  // bool can_authenticate = 19;
  
  /// This connection can be used to sign up (the account is not signed up yet)
  bool can_sign_up = 20;
  
  /* Names. Use whichever one is not empty. Prefer displayName. */
  /// Screen name, eg. Twitter account name
  string screen_name = 4;
  /// Display name, eg. Facebook full name
  string display_name = 5;
  
  /* Further info. May have null values. Most data isn't always shared. */
  /// Url to the actual social media profile
  string avatar_url = 14;
  string blurredAvatar_url = 16;
  string profile_url = 13;
  string description = 6;
  string location = 7;
  string url = 8;
  string email = 12;
  
  /* Use the largest of either friendsCount or followersCount for boasting. */
  int32 friends_count = 9;
  int32 followers_count = 2;
  int32 following_count = 3;
  
  int32 posts_count = 10;
  
  bool verified = 11;
  
}

message DataOAuthCredentials {
  /* Server info, never shared with client */
  /// User id
  string user_id = 4;
  /// Token for OAuth1 and OAuth2
  string token = 1;
  /// Secret token for OAuth1. May be empty string for OAuth2
  string token_secret = 2;
  /// Expiration timestamp in seconds. No expiration if 0
  int32 token_expires = 3;
  
}

message DataTerms {
  // Deliverables
  repeated int32 deliverable_social_platforms = 1; // Identifier from oauth providers
  repeated int32 deliverable_content_formats = 2; // Identifier from content formats config
  string deliverables_description = 3; // (Detail)
  
  // Reward
  int32 reward_cash_value = 4;
  int32 reward_item_or_service_value = 5;
  string reward_item_or_service_description = 6; // (Detail)
  
}

message DataOffer { // 45
  int64 offer_id = 1; // (State) (Summary) (Detail)
  int64 sender_id = 2; // (State) (Summary) (Detail) Account id of the sender who published this offer
  AccountType sender_type = 45; // (State) (Summary) (Detail)
  int64 location_id = 3; // (State) (Summary) (Detail) (Private)
  bool direct = 32; // (State) (Detail) Direct offer, not returned in search results
  
  // Summary
  string title = 4; // (Summary) (Detail)
  string thumbnail_key = 37; // (Post)
  string thumbnail_url = 6; // (Summary) (Detail)
  bytes thumbnail_blurred = 28; // (Summary) (Detail)
  
  // Terms
  DataTerms terms = 27; // (Summary) (Detail)
  repeated int32 primary_categories = 33; // (Denormalized) (Summary) (Detail)
  
  // Embedded sender and location info
  // string location_name = 21; // (Denormalized) (Summary) (Detail) Location nickname or business name
  string sender_name = 21; // (Denormalized) (Summary) (Detail) Sender name
  string sender_avatar_url = 35; // (Denormalized) (Summary) (Detail) Sender avatar
  bytes sender_avatar_blurred = 36; // (Denormalized) (Summary) (Detail) Sender avatar
  string location_address = 9; // (Denormalized) (Summary) (Detail)
  double latitude = 18; // (Denormalized) (Summary) (Detail)
  double longitude = 19; // (Denormalized) (Summary) (Detail)
  // int32 locationOfferCount = 20; // Number of offers at the same location
  // Embedded in Elasticsearch structure as well,
  // only updated for open/draft offers that are not archived
  
  // Detail info
  string description = 5; // (Detail)
  repeated string cover_keys = 34; // (Post)
  repeated string cover_urls = 10; // (Detail)
  repeated bytes covers_blurred = 29; // (Detail)
  repeated int32 categories = 23; // (Detail)
  
  // State for sender
  OfferState state = 12; // (Private)
  OfferStateReason state_reason = 13; // (Private)
  bool archived = 26; // (Private)
  
  // Embedded info for sender
  int32 proposals_proposing = 38; // (Private)
  int32 proposals_negotiating = 39; // (Private)
  int32 proposals_deal = 40; // (Private)
  int32 proposals_rejected = 41; // (Private)
  int32 proposals_dispute = 42; // (Private)
  int32 proposals_resolved = 43; // (Private)
  int32 proposals_complete = 44; // (Private)
  
  // Embedded info for receiver
  /// Identifier of proposal that the public receiver sent already,
  /// allowing the user interface to link immediately to the proposal.
  int64 proposal_id = 22; // (Denormalized) (Receiver)
  // Elasticsearch structure has forward list of proposal ids embedded (map of userid -> proposalid)
  // bool unseen_proposal = 31;
  
}

message DataLocation {
  int64 location_id = 1;
  
  // User-provided nickname of the location (eg. "Waterproof Vests LA") (optional)
  string name = 2;
  
  // Location details. Influencer displays `approximate`, business `detail`
  string approximate = 7;
  string detail = 8;
  string postcode = 9;
  string region_code = 10;
  string country_code = 11;
  
  // Actual location
  double latitude = 4;
  double longitude = 5;
  
  // Location in indexed formats
  int64 s2cell_id = 12;
  int64 geohash_int = 14;
  string geohash = 15;
  
}

/*
message DataAccountState {
  // Session ID. If 0, authentication failed, and the client must create a new account
  int64 sessionId = 1;
  
  // Account ID. If 0, proceed with account creation
  int64 accountId = 2;
  
  // Account type. If not AT_UNKNOWN, account creation may bypass type selection
  AccountType accountType = 3;
  
  GlobalAccountState globalAccountState = 4;
  GlobalAccountStateReason globalAccountStateReason = 5;
  
  AccountLevel accountLevel = 8;
  NotificationFlags notificationFlags = 6;
  
  string firebaseToken = 7;
  
}

message DataAccountSummary {
  string name = 1;
  string description = 2;
  string location = 3;
  string avatarUrl = 4;
  string blurredAvatarUrl = 5;
  
}

message DataAccountDetail {
  repeated int32 categories = 13;
  repeated DataSocialMedia socialMedia = 3;
  
  repeated string coverUrls = 7; // Higher resolution, but same as avatarThumbnailUrl
  repeated string blurredCoverUrls = 12;
  
  string website = 6;
  string email = 9;
  // bool emailVerified = 10;
  
  // Embedded primary location info, if applicable
  string locationName = 14;
  string location = 15;
  double latitude = 4;
  double longitude = 5;
  int64 locationId = 8; // Primary location id
  
}
*/

message DataAccount { // 30
  // DataAccountState state = 1;
  // DataAccountSummary summary = 2;
  // DataAccountDetail detail = 3;
  
  // State
  /// Session ID. If 0, authentication failed, and the client must create a new account
  int64 session_id = 4; // (Private)
  
  /// Account ID. If 0, proceed with account creation
  int64 account_id = 5;
  
  /// Account type. If not AT_UNKNOWN, account signing may bypass type selection
  AccountType account_type = 6;
  
  GlobalAccountState global_account_state = 7; // (Private)
  GlobalAccountStateReason global_account_state_reason = 8; // (Private)
  
  AccountLevel account_level = 9; // (Private)
  NotificationFlags notification_flags = 10; // (Private)
  
  string firebase_token = 11; // (Private)
  
  // Summary
  string name = 12; // (Summary, Detail)
  string description = 13; // (Summary, Detail)
  string location = 14; // (Summary, Detail)
  string avatar_url = 15; // (Summary, Detail)
  string blurred_avatar_url = 16; // (Summary, Detail)
  // bytes blurred_avatar = 17; // (Summary, Detail)
  
  repeated int32 categories = 18; // (Detail)
  // repeated DataSocialMedia social_media = 19; // (Detail)
  map<int32, DataSocialMedia> social_media = 20; // (Detail)
  
  repeated string cover_urls = 21; // (Detail)
  repeated string blurred_cover_urls = 22; // (Detail)
  // repeated bytes blurred_covers = 23; // (Detail)
  
  string website = 24; // (Detail)
  string email = 25; // (Detail, Private)
  // bool emailVerified = 26; // (Detail, Private)
  
  // Embedded primary location info, if applicable
  string location_name = 27; // (Detail)
  string location_address = 28; // (Detail)
  double latitude = 29; // (Detail)
  double longitude = 30; // (Detail)
  int64 location_id = 31; // (Detail, Private) // Primary location id
  
}

message DataProposal {
  int64 proposalId = 1;
  int64 offerId = 2;
  int64 influencerAccountId = 3; // Account which applied
  int64 businessAccountId = 16;
  int64 senderAccountId = 20; // Either influencer or business sent this
  
  /// Embedded data
  string influencerName = 17;
  string businessName = 18;
  string offerTitle = 19;
  
  /// Last chat
  int64 lastChatId = 22;
  
  /// Last seen
  int64 influencerSeenChatId = 23;
  int64 influencerSeenTime = 24;
  int64 businessSeenChatId = 25;
  int64 businessSeenTime = 26;
  
  /// Current chat ID with haggle buttons (deliverables / reward / remarks)
  int64 termsChatId = 4;
  bool influencerWantsDeal = 6;
  bool businessWantsDeal = 5;
  
  bool influencerMarkedDelivered = 7;
  bool influencerMarkedRewarded = 8;
  bool businessMarkedDelivered = 9;
  bool businessMarkedRewarded = 10;
  
  int32 influencerGaveRating = 12;
  int32 businessGaveRating = 11; // 1 to 5, 0 is no rating given (rating given implies complete)
  
  bool influencerDisputed = 15;
  bool businessDisputed = 14;
  
  ProposalState state = 13;
  bool archived = 21;
  
}

message DataProposalChat {
  int64 chatId = 7; // Sequential identifier in the chat stream
  int64 sent = 10; // Sent timestamp
  int64 senderId = 2; // Account which sent
  int64 proposalId = 1; // One chat per proposal
  
  int64 sessionId = 11; // Cleared upon forwarding
  int32 sessionGhostId = 6; // Deduplication client-side (ghost entry)
  
  ProposalChatType type = 8;
  string text = 5; // The written text
  // int64 seen = 9; // 0 if not seen
  
}

/* end of file */
